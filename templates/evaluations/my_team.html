<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mi equipo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

  <p><a href="{% url 'home' %}">&larr; Volver al inicio</a></p>
  <h1>Mi equipo</h1>
  {% load eval_extras %}

  {% if employees %}
    <table border="1" cellpadding="6" cellspacing="0">
      <thead>
        <tr>
          <th>Empleado</th>
          <th>DNI</th>
          <th>Activo</th>
          <th>Puesto de evaluacion</th>
          <th>Plantilla</th>
          <th>Responsable</th>
          <th>Estado</th>
          <th>Score</th>
          <th>Accion</th>
          <th>Alertas</th>
        </tr>
      </thead>
      <tbody>
{% for e in employees %}
  <tr>
    <td>{{ e.full_name }}</td>

    <td>{{ e.dni }}</td>

    <td>
      {% if e.is_active %}Sí{% else %}No{% endif %}
    </td>

    <td>
      {% if e.evaluation_position %}
        {{ e.evaluation_position.code }} - {{ e.evaluation_position.name }}
      {% else %}
        (sin asignar)
      {% endif %}
    </td>

    <td>
      {% with tpl=template_by_position_id|get_item:e.evaluation_position_id %}
        {% if tpl %}
          {{ tpl.name }} v{{ tpl.version }}
        {% else %}
          (no asignada)
        {% endif %}
      {% endwith %}
    </td>

    <td>
      {% if e.manager %}
        {{ e.manager.username }}
      {% else %}
        (sin responsable)
      {% endif %}
    </td>
<td>
  {% with ev=eval_by_employee_id|get_item:e.id %}
    {% if ev %}
      {{ ev.status }}
    {% else %}
      (sin evaluación)
    {% endif %}
  {% endwith %}
</td>

<td>
  {% with ev=eval_by_employee_id|get_item:e.id %}
    {% if ev and ev.final_score != None %}
      {{ ev.final_score }}
    {% else %}
      —
    {% endif %}
  {% endwith %}
</td>

    <td>
      {% if current_period %}
        <a href="/evaluate/{{ e.id }}/{{ current_period.id }}/">Evaluar</a>
      {% else %}
        (sin periodo abierto)
      {% endif %}
    </td>

    <td>
      {% with alerts=alerts_by_employee_id|get_item:e.id %}
        {% if alerts %}
          {% for a in alerts|slice:":3" %}
            <a href="{{ a.action_url }}" style="display:inline-block; padding:2px 6px; margin:2px; border-radius:10px; font-size:12px; border:1px solid #ccc; text-decoration:none; color:#000; background:{% if a.severity == 'danger' %}#ffd6d6{% elif a.severity == 'warning' %}#fff2cc{% else %}#e6f0ff{% endif %};">
              {{ a.text }}
            </a>
          {% endfor %}
          {% if alerts|length > 3 %}
            <span style="font-size:12px;">+{{ alerts|length|add:'-3' }}</span>
          {% endif %}
        {% else %}
          -
        {% endif %}
      {% endwith %}
    </td>
  </tr>

{% endfor %}

      </tbody>
    </table>
  {% else %}
    <p>No hay empleados asignados a tu usuario.</p>
  {% endif %}

</body>
</html>
