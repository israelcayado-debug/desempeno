# Generated by Django 5.2.9 on 2026-01-07 16:25

from django.db import migrations, models


def populate_unique_base_code(apps, schema_editor):
    EvaluationTemplate = apps.get_model("templates_eval", "EvaluationTemplate")

    # Primero, asegurar que todo tiene algún base_code (evitar "")
    for t in EvaluationTemplate.objects.all().order_by("id"):
        bc = (t.base_code or "").strip()
        if not bc:
            # LEGACY_<id> garantiza unicidad
            t.base_code = f"LEGACY_{t.id}"
            t.save(update_fields=["base_code"])

    # Segundo, resolver duplicados (base_code, version)
    seen = set()
    for t in EvaluationTemplate.objects.all().order_by("id"):
        key = (t.base_code, t.version)
        if key in seen:
            # si hay duplicado, lo hacemos único sin tocar version
            t.base_code = f"{t.base_code}_{t.id}"
            t.save(update_fields=["base_code"])
            key = (t.base_code, t.version)
        seen.add(key)


class Migration(migrations.Migration):

    dependencies = [
        ('templates_eval', '0004_templateactive'),
    ]

    operations = [
        migrations.AddField(
            model_name='evaluationtemplate',
            name='base_code',
            field=models.CharField(blank=True, default='', max_length=20),
        ),
        migrations.RunPython(populate_unique_base_code, migrations.RunPython.noop),
        migrations.AddConstraint(
            model_name='evaluationtemplate',
            constraint=models.UniqueConstraint(fields=('base_code', 'version'), name='uniq_template_base_version'),
        ),
    ]
